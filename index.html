<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/SFP_Raport/manifest.json">
    <link rel="icon" href="data:,">
    <title>ZAMÓWIENIA SFP v2.23</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 5px; background: #fff; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        /* html { font-size: 120% !important;} */

        /* NAGŁÓWEK GŁÓWNY (Excel Style) - ZAWSZE WIDOCZNY */
        #mainHeader th { background: #2c4d82; color: white; text-align: center; padding: 2px; font-size: 1.00rem; border: 1px solid #fff; }

        /* WIERSZE GŁÓWNE */
        .master-row td { border: 1px solid #ccc; padding: 12px 5px; text-align: center; font-size: 1.25rem; font-weight: bold; cursor: pointer; overflow: hidden; }         
        .row-type-1 { background-color: #ffffff; }
        .row-type-2 { background-color: #d9e1f2; }

        /* KOLORY STATUSÓW */
        .st-cell { color: white; text-transform: capitalize; }
        .st-started  { background-color: #10ac5c !important; }
        .st-released { background-color: #005040 !important; } 
        .st-prepared { background-color: #003070 !important; }
        .st-picking  { background-color: #555555  !important; color: white;}
        .st-picked   { background-color: #555555  !important; color: #808080;}

        /* SEKCJE ROZWIJANE */
        .detail-row { display: none; background: #fff; }      
        .detail-cell { padding: 0 !important; }

        .extra-table, .inner-table { width: 100%; border-bottom: 1px solid #ccc; }
        .extra-table th, .inner-table th { background: #2c4d82; color: white; text-align: center; padding: 2px; font-size: 0.90rem; border: 1px solid #fff; } 
        .extra-table th:nth-child(1) { width: 10%; } 
        .extra-table th:nth-child(2) { width: 13%; } 
        .extra-table th:nth-child(3) { width: 13%; } 
        .extra-table th:nth-child(4) { width: 23%; } 
        .extra-table th:nth-child(5) { width: 8%; }
        .extra-table th:nth-child(6) { width: 14%; } 
        .extra-table th:nth-child(7) { width: 13%; } 
        .extra-table th:nth-child(8) { width: 6%; }
        .extra-table td, .inner-table td { border: 1px solid #ccc; padding: 2px 2px; text-align: center; font-size: 0.90rem; font-weight: normal; cursor: pointer; white-space: normal; word-break: break-all; } 
        .inner-table th:nth-child(1) { width: 10%; } 
        .inner-table th:nth-child(2) { width: 38%; } 
        .inner-table td:nth-child(2) {font-size: 0.7rem; }
        .inner-table th:nth-child(3) { width: 9%; } 
        .inner-table th:nth-child(4) { width: 17%; } 
        .inner-table th:nth-child(5) { width: 13%; }
        .inner-table td:nth-child(5) {font-size: 0.7rem; }
        .inner-table th:nth-child(6) { width: 12%; } 
        .scroll-wrapper { overflow-x: auto; width: 100%; }
        
    </style>
</head>
<body>

<div id="container">
    <table>
        <thead id="mainHeader">
            <tr>
                <th style="width:10%">Time</th>
                <th style="width:16%">Status</th>
                <th style="width:17%">Center</th>
                <th style="width:20%">Product</th>
                <th style="width:10%">Qty</th>
                <th style="width:27%">Location</th>
            </tr>
        </thead>
        <tbody id="mainBody"></tbody>
    </table>
</div>

<div style="text-align: center; width: 100%;"><span id="zegar-cyfrowy" style="font-size: 4em; font-weight: bold; display: inline-block;">--:--:--</span><br><span id="display8887">----</span><br><span id="display8889"></span></div>

<div class="font-controls" style="display: flex; gap:5px; margin: 5px;"> 
<button type="button" onclick="adjustFont(0.9)" style="padding: 5px 5px; font-size: 1rem; cursor: pointer; border-radius: 5px;">A-</button>        
<button type="button" onclick="adjustFont(1.1)" style="padding: 5px 5px; font-size: 1rem; cursor: pointer; border-radius: 5px;">A+</button>
</div>
    
<script>
    let rawData = `Zlecenie;RelatedPO;R Order No;Start Date;Time;Status;POStatus;Center;Target Qty.;UOM;Product;Container;Quant;Location;LotNo;Expire`;
    let isFocused = false;
    let lastModified = 0;
    let lastRowCount = 0;
    let now = Date.now();
    let lastInteractionTime = Date.now();
    
    async function odswiezDane() {          
        try {
            const response = await fetch('dane.txt?t=' + now);
            const fetchedText = await response.text();
            lastModified = new Date(response.headers.get('Last-Modified')).getTime();
            const aktualizacja = parseInt((now - lastModified)/1000);           
            // Sprawdź czy treść się zmieniła i nie jest pusta       
             if (fetchedText && fetchedText !== rawData && aktualizacja < 600 ) {          
                rawData = fetchedText;                 
                const body = document.getElementById('mainBody');
                if (body) { body.innerHTML = ''; build(); }
                const currentRows = document.querySelectorAll('.master-row').length;               
                if (currentRows > lastRowCount) { playBeep(660, 1000); window.scrollTo({ top: 0, behavior: 'smooth' }); }
                lastRowCount = currentRows;                 
                }
                } catch (e) { console.log("Blad !!!");}   
    }

    setInterval(odswiezDane, 20000);  
    setTimeout(odswiezDane, 1000);  

    function getTimeStyle(timeStr) {
        if (!timeStr || !timeStr.includes(':')) return { bg: '#fff', text: '#000' };
        const parts = timeStr.split(':');
        const total = (parseInt(parts[0]) * 60) + parseInt(parts[1]);
        if (total < 15) return { bg: '#ffffff', text: '#000000' };
        if (total <= 24) return { bg: '#ffff00', text: '#000000' };
        if (total <= 240) return { bg: '#ff0000', text: '#ffffff' };
        return { bg: '#000000', text: '#ffffff' };
    }

    function build() {
        const lines = rawData.trim().split('\n');
        const headers = lines[0].split(';');
        const rows = lines.slice(1);
        const body = document.getElementById('mainBody');

        const mainIdx = [4, 6, 7, 10, 12, 13];
        const extraIdx = [0, 1, 2, 3, 4, 5, 8, 9];
        const detailIdx = [10, 11, 12, 13, 14, 15];

        const groups = {};
        rows.forEach(line => {
            const cols = line.split(';');
            const id = cols[2];
            if (!groups[id]) groups[id] = [];
            groups[id].push(cols);
        });

        Object.keys(groups).forEach((id, index) => {
            const dataRows = groups[id];
            const first = dataRows[0];
            const tStyle = getTimeStyle(first[4]);
            const rowClass = (index % 2 === 0) ? 'row-type-1' : 'row-type-2';

            const masterTr = document.createElement('tr');
            masterTr.className = `master-row ${rowClass}`;
            masterTr.id = `master-${id}`;
            masterTr.innerHTML = `
                <td style="background:${tStyle.bg}; color:${tStyle.text}">${first[4]}</td>                
               
                <td class="st-cell st-${first[6].toLowerCase()}  ${first[5] !== 'New' ? 'st-picking' : ''}"> ${first[5] !== 'New' ? first[5] : first[6]}</td>
                ${first[5] == 'Picking' ? `<td class="st-picking">${first[7]}</td><td class="st-picking">${first[10]}</td><td class="st-picking">${first[12]}</td><td class="st-picking">${first[13]}</td>` : ``} 
                ${first[5] == 'Picked'  ? `<td class="st-picked">${first[7]}</td><td class="st-picked">${first[10]}</td><td class="st-picked">${first[12]}</td><td class="st-picked">${first[13]}</td>` : ``} 
                ${first[5] == 'New'     ? `<td>${first[7]}</td><td>${first[10]}</td> <td>${first[12]}</td> <td>${first[13]}</td>` : ``} 
                `;

            const detailTr = document.createElement('tr');
            detailTr.className = 'detail-row';
            detailTr.id = `detail-${id}`;
            
            const extraHeader = extraIdx.map(i => `<th>${headers[i]}</th>`).join('');
            const extraData = extraIdx.map(i => `<td>${first[i]}</td>`).join('');
            const innerHeader = detailIdx.map(i => `<th>${headers[i]}</th>`).join('');
            const innerRows = dataRows.map(r => `<tr>${detailIdx.map(i => `<td>${r[i]}</td>`).join('')}</tr>`).join('');

            detailTr.innerHTML = `
                <td colspan="6" class="detail-cell">
                    <table class="extra-table"><thead><tr>${extraHeader}</tr></thead><tbody><tr>${extraData}</tr></tbody></table>
                    <div class="scroll-wrapper">
                        <table class="inner-table">
                            <thead><tr>${innerHeader}</tr></thead>
                            <tbody>${innerRows}</tbody>
                        </table>
                    </div>
                </td>`;

            masterTr.onclick = () => isFocused ? reset() : focusOrder(id);
            body.appendChild(masterTr);
            body.appendChild(detailTr);
        });
    }

    function focusOrder(id) {
        isFocused = true;
        // Nagłówek (#mainHeader) pozostaje widoczny (nie zmieniamy display)
        document.querySelectorAll('.master-row').forEach(r => r.style.display = 'none');
        document.getElementById(`master-${id}`).style.display = 'table-row';
        document.getElementById(`detail-${id}`).style.display = 'table-row';
        window.scrollTo(0,0);
    }

    function reset() {
        isFocused = false;
        document.querySelectorAll('.master-row').forEach(r => r.style.display = 'table-row');
        document.querySelectorAll('.detail-row').forEach(r => r.style.display = 'none');
    }

    window.onload = build;

function adjustFont(multiplier) {
  const html = document.documentElement;
  const currentSize = parseFloat(window.getComputedStyle(html).fontSize);
  let newSize = currentSize * multiplier;
  const MIN_SIZE = 6; // Minimalna czcionka (px)
  const MAX_SIZE = 60; // Maksymalna czcionka (px)
  if (newSize < MIN_SIZE) newSize = MIN_SIZE;
  if (newSize > MAX_SIZE) newSize = MAX_SIZE;
  const finalSizeStr = newSize + "px";  
  html.style.fontSize = finalSizeStr;
  localStorage.setItem("globalFontSize", finalSizeStr);
}

document.addEventListener("DOMContentLoaded", function() {
    const savedSize = localStorage.getItem("globalFontSize");
    if (savedSize) {document.documentElement.style.fontSize = savedSize;}
});

function aktualizujZegar() {
        const teraz = new Date();        
        // Pobieranie godzin, minut i sekund
        let h = teraz.getHours().toString().padStart(2, '0');
        let m = teraz.getMinutes().toString().padStart(2, '0');
        let s = teraz.getSeconds().toString().padStart(2, '0');
        // Składanie czasu w całość
        document.getElementById('zegar-cyfrowy').innerHTML = h + ":" + m + ":" + s;

        const displayElement1 = document.getElementById('display8887');
        const displayElement2 = document.getElementById('display8889');
        now = Date.now();   
        const aktualizacja = parseInt((now - lastModified)/1000);
     if (aktualizacja < 300)  {displayElement1.innerText = "Odczytane: " + aktualizacja + " s";} 
     if (aktualizacja > 299 && aktualizacja < 600 && aktualizacja % 60 === 0)  {
         playBeep(330, 1000);     
         displayElement1.innerText = "Dane nieaktualne";
         console.log("Dane nieaktualne. Aktualizacja 300 - 600:", aktualizacja);
     } 
     if ((now - lastInteractionTime) > 900000)  {displayElement2.innerText = "Czas bezczynnosci: " + parseInt((now - lastInteractionTime)/60000) + " min";} else {displayElement2.innerText = "";}
     if (aktualizacja > 599 && aktualizacja % 120 === 0)  {
         playBeep(660, 2000); 
         const body = document.getElementById('mainBody');
         body.innerHTML = '';
         rawData = ``;
         build();
         displayElement1.innerText = "Dane nieaktualne. Tabela usunięta. Czekam na nowy raport";
         console.log("Dane nieaktualne. Aktualizacja 600+:", aktualizacja);
     } 
    
    }
    // Odświeżanie co 1 sekundę
    setInterval(aktualizujZegar, 1000);    
    // Start natychmiastowy
    // aktualizujZegar();

    // *********************************** refresh
  

    // 1. Rejestrujemy każde kliknięcie w tabelę, aby zresetować licznik 60s
    // document.addEventListener('click', function(e) {   if (e.target.closest('.extra-table, .inner-table, .detail-row')) {    lastInteractionTime = Date.now();   }  });
    document.addEventListener('click', function() { lastInteractionTime = Date.now(); });
    function manageRefresh() {
        const now2 = Date.now();
        const timeSinceInteraction = now2 - lastInteractionTime;           
        if (typeof isFocused !== 'undefined' && isFocused === true && timeSinceInteraction >= 60000) { reset(); } 

    }
    setInterval(manageRefresh, 2000);                                             
    // **************************************** full screen
    document.addEventListener("click", function() { document.documentElement.requestFullscreen(); }, { once: true });
    
     // **************************************** beep
    function playBeep(frequency = 440, duration = 200) {
    const context = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = context.createOscillator();
    const gain = context.createGain();

    oscillator.type = 'sine'; // Typ dźwięku: 'sine', 'square', 'sawtooth', 'triangle'
    oscillator.frequency.value = frequency; // Częstotliwość w Hz (np. 440 to dźwięk A)    
    oscillator.connect(gain);
    gain.connect(context.destination);
    oscillator.start();    
    // Płynne wyciszenie, żeby uniknąć "trzeszczenia" na końcu
    gain.gain.exponentialRampToValueAtTime(0.00001, context.currentTime + duration / 1000);    
    oscillator.stop(context.currentTime + duration / 1000);
    }
    // **************************************** beep
    
</script>
</body>
</html>














